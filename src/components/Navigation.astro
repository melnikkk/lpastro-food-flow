<nav aria-label="Primary navigation" class="nav-root" data-nav-root>
  <ul
    class="text-muted-foreground nav-shell flex gap-3 text-xs font-medium sm:gap-6 sm:text-sm"
    data-nav-shell
  >
    <li>
      <a
        href="#how-it-works"
        class="hover:text-primary after:bg-primary relative text-lg transition-colors after:absolute after:bottom-[-2px] after:left-0 after:h-[2px] after:w-0 after:transition-all after:duration-300 after:ease-in-out hover:after:w-full"
        >How It Works</a
      >
    </li>
    <li>
      <a
        href="#features"
        class="hover:text-primary after:bg-primary relative text-lg transition-colors after:absolute after:bottom-[-2px] after:left-0 after:h-[2px] after:w-0 after:transition-all after:duration-300 after:ease-in-out hover:after:w-full"
        >Features</a
      >
    </li>
    <li>
      <a
        href="#who"
        class="hover:text-primary after:bg-primary relative text-lg transition-colors after:absolute after:bottom-[-2px] after:left-0 after:h-[2px] after:w-0 after:transition-all after:duration-300 after:ease-in-out hover:after:w-full"
        >Who It's For</a
      >
    </li>
  </ul>
</nav>

<style>
  .nav-root {
    --nav-push: 0px;
    pointer-events: none;
    position: fixed;
    right: 1rem;
    top: 1rem;
    z-index: 50;
    transform: translateY(calc(var(--nav-push) * -1));
  }

  .nav-shell {
    --nav-bg-opacity: 0;
    --nav-border-opacity: 0;
    --nav-shadow-opacity: 0;

    pointer-events: auto;
    border: 1px solid rgb(255 255 255 / var(--nav-border-opacity));
    border-radius: 999px;
    background: rgb(255 255 255 / var(--nav-bg-opacity));
    backdrop-filter: saturate(150%) blur(14px);
    -webkit-backdrop-filter: saturate(150%) blur(14px);
    box-shadow: 0 10px 28px rgb(0 0 0 / var(--nav-shadow-opacity));
    padding: 0.5rem 0.9rem;
    transform: translateY(0);
    opacity: 1;
    transition:
      background-color 220ms ease,
      border-color 220ms ease,
      box-shadow 220ms ease,
      transform 320ms ease,
      opacity 320ms ease;
    will-change: transform, opacity, background-color;
  }

  .nav-shell.is-drop-in {
    animation: nav-drop-in 420ms cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  @keyframes nav-drop-in {
    0% {
      opacity: 0;
      transform: translateY(-1.4rem);
    }

    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (min-width: 640px) {
    .nav-root {
      right: 2rem;
      top: 1.5rem;
    }

    .nav-shell {
      padding: 0.65rem 1.1rem;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .nav-shell,
    .nav-shell.is-drop-in {
      animation: none;
      transition: none;
    }
  }
</style>

<script>
  (() => {
    const navRoot = document.querySelector<HTMLElement>('[data-nav-root]');
    const navShell = document.querySelector<HTMLElement>('[data-nav-shell]');
    if (!navRoot || !navShell) return;

    const footer = document.querySelector('footer');
    let lastY = window.scrollY;
    let wasPushedByFooter = false;
    let dropInTimer: number | undefined;

    const clamp = (value: number, min: number, max: number) =>
      Math.min(Math.max(value, min), max);

    const updateGlass = () => {
      const y = window.scrollY;
      const progress = clamp((y - 6) / 150, 0, 1);
      navShell.style.setProperty('--nav-bg-opacity', (0.76 * progress).toFixed(3));
      navShell.style.setProperty('--nav-border-opacity', (0.22 * progress).toFixed(3));
      navShell.style.setProperty('--nav-shadow-opacity', (0.18 * progress).toFixed(3));
    };

    const showNavWithDrop = () => {
      navShell.classList.remove('is-drop-in');
      // Restart animation each time footer releases while scrolling up.
      void navShell.offsetWidth;
      navShell.classList.add('is-drop-in');

      window.clearTimeout(dropInTimer);
      dropInTimer = window.setTimeout(() => {
        navShell.classList.remove('is-drop-in');
      }, 450);
    };

    const updateFooterPush = () => {
      if (!footer) {
        navRoot.style.setProperty('--nav-push', '0px');
        return false;
      }

      const stickyTop = parseFloat(window.getComputedStyle(navRoot).top) || 0;
      const navHeight = navShell.offsetHeight;
      const footerTop = footer.getBoundingClientRect().top;
      const push = Math.max(0, stickyTop + navHeight - footerTop);

      navRoot.style.setProperty('--nav-push', `${push.toFixed(2)}px`);
      return push > 0.5;
    };

    const handleScroll = () => {
      const currentY = window.scrollY;
      const scrollingUp = currentY < lastY;

      updateGlass();
      const pushedByFooter = updateFooterPush();

      if (scrollingUp && wasPushedByFooter && !pushedByFooter) {
        showNavWithDrop();
      }

      wasPushedByFooter = pushedByFooter;
      lastY = currentY;
    };

    updateGlass();
    updateFooterPush();
    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleScroll, { passive: true });
  })();
</script>
